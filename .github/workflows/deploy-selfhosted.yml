name: Deploy on master (self-hosted)

on:
  push:
    branches: [ master ]

jobs:
  deploy:
    runs-on: [ self-hosted, ec2-prod ]
    steps:
      - uses: actions/checkout@v4

      - name: Deploy with PM2 on the instance
        run: |
          set -euo pipefail
          cd /home/ec2-user/app

          if [ ! -d .git ]; then
            git clone --depth 1 https://github.com/STIR-Lab/Truman_SocialSim.git .
          fi

          git fetch origin
          git reset --hard origin/master

          if [ -f package-lock.json ]; then npm ci || npm install; else npm install; fi
          if grep -q '"build"' package.json 2>/dev/null; then npm run build; fi

          if [ -f ecosystem.config.js ]; then
            pm2 reload ecosystem.config.js --env production || pm2 start ecosystem.config.js --env production
            pm2 save
          else
            pm2 reload app || pm2 start app.js --name app
            pm2 save
          fi
