name: Deploy on master (self-hosted)

on:
  push:
    branches: [ master ]

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - uses: actions/checkout@v4

      - name: Deploy with PM2 on the EC2 runner
        env:
          NODE_ENV: production
        run: |
          set -euo pipefail
          cd /home/ec2-user/app

          echo "ðŸ”„ Updating code..."
          if [ ! -d .git ]; then
            git clone --depth 1 https://github.com/STIR-Lab/Truman_SocialSim.git .
          fi
          git fetch origin
          git reset --hard origin/master

          echo "ðŸ“¦ Installing production dependencies (ignoring peer conflicts)..."
          if [ -f package-lock.json ]; then
            NPM_CONFIG_LEGACY_PEER_DEPS=true npm ci --omit=dev --no-audit --no-fund
          else
            NPM_CONFIG_LEGACY_PEER_DEPS=true npm install --omit=dev --no-audit --no-fund
          fi

          echo "ðŸ—ï¸ Building app (if build script exists)..."
          if grep -q '"build"' package.json 2>/dev/null; then
            npm run build
          fi

          echo "ðŸš€ Reloading PM2..."
          if [ -f ecosystem.config.js ]; then
            pm2 reload ecosystem.config.js --env production || pm2 start ecosystem.config.js --env production
            pm2 save
          else
            pm2 reload app || pm2 start app.js --name app
            pm2 save
          fi

          echo "âœ… Deployment complete."
